"""
These meta-datasources operate on :class:`revscoring.Datasource`'s that
return `list`'s of items and produce vectors out of the same.

.. autoclass:: revscoring.datasources.meta.vectors
"""
import numpy as np
from gensim.models.keyedvectors import KeyedVectors

from ..datasource import Datasource


def load_kv(self, path, prefix="~/.word2vec/", limit=None):
    full_path = prefix + path
    return KeyedVectors.load_word2vec_format(full_path, binary=True,
                                             limit=limit)


class word2vec(Datasource):
    """
    Generates vectors for a list of items generated by another
    datasource.

    :Parameters:
        items_datasource : :class:`revscoring.Datasource`
            A datasource that returns a list of words.
        w2v_prefix : `string`
            prefix path where vectors are stores
        w2v : `string`
            name of word vector file to load
        returns : `func`
            A function that represents the type of value that will be
            contained in the vector.  When called without an argument, this
            function should return the default value (for missing) keys
            in the dict.
        dim : `int`
            The dimension of the vectors
        limit : `int`
            Max number of word vectors to load
        name : `str`
            A name for the `revscoring.FeatureVector`
    """

    def __init__(self, items_datasource, word_vectors,
                 dim=300, returns=np.float64, name=None):
        name = self._format_name(name, [items_datasource])
        self.dim = dim
        self.w2v = word_vectors
        super().__init__(name, self.process, depends_on=[items_datasource])

    def process(self, d):
        return [self.w2v[w] if w in self.w2v else np.zeros(self.dim)
                for w in d]
